# ===== manage.py =====
#!/usr/bin/env python
import os
import sys

def main():
    os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'shuddhswad_clone.settings')
    from django.core.management import execute_from_command_line
    execute_from_command_line(sys.argv)

if __name__ == '__main__':
    main()


# ===== shuddhswad_clone/__init__.py =====


# ===== shuddhswad_clone/settings.py =====
import os
from pathlib import Path

BASE_DIR = Path(__file__).resolve().parent.parent

SECRET_KEY = "your-secret-key"
DEBUG = True
ALLOWED_HOSTS = []

INSTALLED_APPS = [
    "django.contrib.admin",
    "django.contrib.auth",
    "django.contrib.contenttypes",
    "django.contrib.sessions",
    "django.contrib.messages",
    "django.contrib.staticfiles",
    "shop",
]

MIDDLEWARE = [
    "django.middleware.security.SecurityMiddleware",
    "django.contrib.sessions.middleware.SessionMiddleware",
    "django.middleware.common.CommonMiddleware",
    "django.middleware.csrf.CsrfViewMiddleware",
    "django.contrib.auth.middleware.AuthenticationMiddleware",
    "django.contrib.messages.middleware.MessageMiddleware",
    "django.middleware.clickjacking.XFrameOptionsMiddleware",
]

ROOT_URLCONF = "shuddhswad_clone.urls"

TEMPLATES = [
    {
        "BACKEND": "django.template.backends.django.DjangoTemplates",
        "DIRS": [BASE_DIR / "shop" / "templates"],
        "APP_DIRS": True,
        "OPTIONS": {
            "context_processors": [
                "django.template.context_processors.debug",
                "django.template.context_processors.request",
                "django.contrib.auth.context_processors.auth",
                "django.contrib.messages.context_processors.messages",
            ],
        },
    },
]

WSGI_APPLICATION = "shuddhswad_clone.wsgi.application"

DATABASES = {
    "default": {
        "ENGINE": "django.db.backends.sqlite3",
        "NAME": BASE_DIR / "db.sqlite3",
    }
}

AUTH_PASSWORD_VALIDATORS = []
LANGUAGE_CODE = "en-us"
TIME_ZONE = "Asia/Kolkata"
USE_I18N = True
USE_TZ = True

STATIC_URL = "static/"
STATICFILES_DIRS = [BASE_DIR / "static"]

DEFAULT_AUTO_FIELD = "django.db.models.BigAutoField"


# ===== shuddhswad_clone/urls.py =====
from django.contrib import admin
from django.urls import path, include

urlpatterns = [
    path("admin/", admin.site.urls),
    path("", include("shop.urls")),
]


# ===== shuddhswad_clone/wsgi.py =====
import os
from django.core.wsgi import get_wsgi_application

os.environ.setdefault("DJANGO_SETTINGS_MODULE", "shuddhswad_clone.settings")
application = get_wsgi_application()


# ===== shop/apps.py =====
from django.apps import AppConfig

class ShopConfig(AppConfig):
    default_auto_field = "django.db.models.BigAutoField"
    name = "shop"


# ===== shop/models.py =====
from django.db import models
from django.contrib.auth.models import User

class Product(models.Model):
    title = models.CharField(max_length=200)
    slug = models.SlugField(unique=True)
    description = models.TextField(blank=True)
    price = models.DecimalField(max_digits=8, decimal_places=2)
    stock = models.PositiveIntegerField(default=0)
    image = models.ImageField(upload_to="products/", blank=True, null=True)

    def __str__(self):
        return self.title

class Order(models.Model):
    STATUS_CHOICES = [
        ("pending", "Pending"),
        ("confirmed", "Confirmed"),
        ("delivered", "Delivered"),
    ]
    user = models.ForeignKey(User, on_delete=models.CASCADE)
    created_at = models.DateTimeField(auto_now_add=True)
    status = models.CharField(max_length=20, choices=STATUS_CHOICES, default="pending")

    def __str__(self):
        return f"Order #{self.id} - {self.user.username}"

class OrderItem(models.Model):
    order = models.ForeignKey(Order, on_delete=models.CASCADE, related_name="items")
    product = models.ForeignKey(Product, on_delete=models.CASCADE)
    qty = models.PositiveIntegerField(default=1)

    def __str__(self):
        return f"{self.qty}x {self.product.title}"


# ===== shop/admin.py =====
from django.contrib import admin
from .models import Product, Order, OrderItem

admin.site.register(Product)
admin.site.register(Order)
admin.site.register(OrderItem)


# ===== shop/views.py =====
from django.shortcuts import render, get_object_or_404, redirect
from .models import Product

def home(request):
    products = Product.objects.all()
    return render(request, "home.html", {"products": products})

def product_detail(request, slug):
    product = get_object_or_404(Product, slug=slug)
    return render(request, "product_detail.html", {"product": product})

def cart(request):
    cart_items = request.session.get("cart", {})
    products = []
    total = 0
    for pid, qty in cart_items.items():
        p = Product.objects.get(id=pid)
        products.append({"product": p, "qty": qty, "subtotal": p.price * qty})
        total += p.price * qty
    return render(request, "cart.html", {"items": products, "total": total})

def add_to_cart(request, pid):
    cart = request.session.get("cart", {})
    cart[str(pid)] = cart.get(str(pid), 0) + 1
    request.session["cart"] = cart
    return redirect("cart")


# ===== shop/urls.py =====
from django.urls import path
from . import views

urlpatterns = [
    path("", views.home, name="home"),
    path("product/<slug:slug>/", views.product_detail, name="product_detail"),
    path("cart/", views.cart, name="cart"),
    path("add-to-cart/<int:pid>/", views.add_to_cart, name="add_to_cart"),
]


# ===== shop/templates/base.html =====
"""
<!DOCTYPE html>
<html>
<head>
  <title>ShuddhSwad Clone</title>
</head>
<body>
  <nav>
    <a href="/">Home</a> | 
    <a href="/cart/">Cart</a> | 
    <a href="/admin/">Admin</a>
  </nav>
  <hr>
  {% block content %}{% endblock %}
</body>
</html>
"""


# ===== shop/templates/home.html =====
"""
{% extends "base.html" %}
{% block content %}
<h2>Our Products</h2>
<ul>
  {% for p in products %}
    <li>
      <a href="{% url 'product_detail' p.slug %}">
        {{ p.title }} - ₹{{ p.price }}
      </a>
      <a href="{% url 'add_to_cart' p.id %}">[Add to Cart]</a>
    </li>
  {% endfor %}
</ul>
{% endblock %}
"""


# ===== shop/templates/product_detail.html =====
"""
{% extends "base.html" %}
{% block content %}
<h2>{{ product.title }}</h2>
<p>{{ product.description }}</p>
<p>Price: ₹{{ product.price }}</p>
<a href="{% url 'add_to_cart' product.id %}">Add to Cart</a>
{% endblock %}
"""


# ===== shop/templates/cart.html =====
"""
{% extends "base.html" %}
{% block content %}
<h2>Your Cart</h2>
<ul>
  {% for item in items %}
    <li>{{ item.product.title }} - Qty: {{ item.qty }} - ₹{{ item.subtotal }}</li>
  {% endfor %}
</ul>
<h3>Total: ₹{{ total }}</h3>
{% endblock %}
"""
